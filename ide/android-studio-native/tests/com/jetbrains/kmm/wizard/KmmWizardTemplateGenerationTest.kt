/*
 * Copyright 2010-2020 JetBrains s.r.o. and Kotlin Programming Language contributors.
 * Use of this source code is governed by the Apache 2.0 license that can be found in the license/LICENSE.txt file.
 */

package com.jetbrains.kmm.wizard

import com.android.tools.idea.gradle.util.LocalProperties
import com.android.tools.idea.sdk.SdkPaths
import com.android.tools.idea.util.toIoFile
import com.intellij.openapi.vfs.LocalFileSystem
import com.intellij.openapi.vfs.VirtualFile
import com.intellij.openapi.vfs.VirtualFileFilter
import com.intellij.rt.execution.junit.FileComparisonFailure
import com.intellij.testFramework.PlatformTestUtil
import com.intellij.util.containers.isEmpty
import org.jetbrains.kotlin.test.KotlinTestUtils
import org.jetbrains.kotlin.test.testFramework.runWriteAction
import org.jetbrains.kotlin.tools.projectWizard.cli.BuildSystem
import org.jetbrains.kotlin.tools.projectWizard.cli.assertSuccess
import org.jetbrains.kotlin.tools.projectWizard.phases.GenerationPhase
import org.jetbrains.kotlin.tools.projectWizard.wizard.AbstractNewWizardProjectImportTest
import org.jetbrains.kotlin.tools.projectWizard.wizard.Wizard
import org.jetbrains.kotlin.tools.projectWizard.wizard.services.TestWizardServices
import java.io.File
import java.nio.charset.StandardCharsets
import java.nio.file.Files
import java.nio.file.Path

object FilelessDirectoryFilter : VirtualFileFilter {
    override fun accept(directory: VirtualFile?): Boolean {
        if (directory == null) return false

        if (!directory.isDirectory) return true

        val filesUnderDirectory = Files.walk(directory.toIoFile().toPath())
            .filter { path -> !Files.isDirectory(path) }

        return !filesUnderDirectory.isEmpty()

    }

}

class KmmWizardTemplateGenerationTest : AbstractNewWizardProjectImportTest() {

    private val referenceProjectSubdir = "generationExpected"

    // this directory contains reference result of wizard execution
    private val testdataExpectedDir = File("testData/wizard/expected")
    private lateinit var testdataExpectedVfs: VirtualFile

    // these files are supposed to be generated by Android Studio before KmmWizard execution
    private val testdataPrerequisitesDir = File("testData/wizard/prerequisites")
    private lateinit var testdataPrerequisitesVfs: VirtualFile

    private lateinit var androidSdkDir: File

    private fun projectDescriptionFor(destination: File) = ProjectDescription(
        "TestApplication",
        destination.toPath(),
        "app",
        "org.jetbrains",
        androidSdkDir.toPath()
    )

    private fun generateLocalProperties(destination: VirtualFile) = runWriteAction {
        val localProperties = "sdk.dir=$androidSdkDir\n"

        destination.createChildData(this, "local.properties").apply {
            setBinaryContent(
                localProperties.toByteArray(StandardCharsets.UTF_8),
                modificationStamp,
                timeStamp
            )
        }
    }

    private fun refreshAndCopy(source: VirtualFile, destination: VirtualFile) {
        // dir requires refresh prior being copied
        Files.walk(source.toIoFile().toPath())
            .filter { path -> Files.isDirectory(path) }
            .forEach { path -> synchronizeTempDirVfs(path) }

        copyDirContentsTo(source, destination)
    }

    override fun setUp() {
        super.setUp()
        assertTrue("Test environment is broken: expectedDir is absent", testdataExpectedDir.exists())
        assertTrue("Test environment is broken: prerequisitesDir is absent", testdataPrerequisitesDir.exists())

        testdataExpectedVfs = LocalFileSystem.getInstance().findFileByIoFile(testdataExpectedDir)!!
        testdataPrerequisitesVfs = LocalFileSystem.getInstance().findFileByIoFile(testdataPrerequisitesDir)!!

        androidSdkDir = KotlinTestUtils.findAndroidSdk()
        assertNotNull("Android SDK is not found", androidSdkDir)
    }

    fun testGenerationIntact() {
        val generationActualDir = KotlinTestUtils.tmpDir("generationActual")
        val generationActualVfs = LocalFileSystem.getInstance().findFileByIoFile(generationActualDir)!!

        val generationExpectedDir = KotlinTestUtils.tmpDir(referenceProjectSubdir)
        val generationExpectedVfs = LocalFileSystem.getInstance().findFileByIoFile(generationExpectedDir)!!

        generateLocalProperties(generationExpectedVfs)

        refreshAndCopy(testdataPrerequisitesVfs, generationExpectedVfs)
        refreshAndCopy(testdataExpectedVfs, generationExpectedVfs)

        refreshAndCopy(testdataPrerequisitesVfs, generationActualVfs)

        val wizard = KmmWizard(projectDescriptionFor(generationActualDir), true)

        wizard.apply(
            WizardConfiguration.commonServices + WizardConfiguration.productionServices,
            GenerationPhase.ALL
        ).assertSuccess()

        // since reference files moved to temp directory, IDEA does not provide handy tool for
        // update with new value of actual
        try {
            PlatformTestUtil.assertDirectoriesEqual(generationExpectedVfs, generationActualVfs, FilelessDirectoryFilter)
        } catch (e: FileComparisonFailure) {
            val relativeIndex = e.filePath.indexOf(referenceProjectSubdir) + referenceProjectSubdir.length
            val path = testdataExpectedDir.absoluteFile.resolve(e.filePath.substring(relativeIndex + 1))
            throw FileComparisonFailure(e.message, e.expected, e.actual, path.toString(), e.actualFilePath)
        }
    }

    fun testImport() {
        val importDir = KotlinTestUtils.tmpDir("import")
        val importVfs = LocalFileSystem.getInstance().findFileByIoFile(importDir)!!

        refreshAndCopy(testdataPrerequisitesVfs, importVfs)

        prepareGradleBuildSystem(importDir.toPath())

        val wizard = KmmWizard(projectDescriptionFor(importDir), true)

        wizard.apply(
            WizardConfiguration.commonServices + TestWizardServices.createProjectDependent(project),
            GenerationPhase.ALL
        ).assertSuccess()

        // Gradle import does not check correctness of specified Android Sdk location

        val projectAndroidSdkPath = LocalProperties(importDir).androidSdkPath
        val androidSdkValidation = SdkPaths.validateAndroidSdk(projectAndroidSdkPath, true)

        assertTrue("Wizard generated invalid Android SDK: " + androidSdkValidation.message, androidSdkValidation.success)
    }

    override fun createWizard(directory: Path, buildSystem: BuildSystem, projectDirectory: Path): Wizard {
        TODO("Not needed")
    }
}

